<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>天氣小工具</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        max-width: 600px;
      }
      .city {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 12px;
      }
      .error {
        color: #c00;
        font-weight: bold;
      }
      ul {
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <h1>目前地點天氣</h1>
    <div id="status">正在取得您的位置...</div>
    <div id="location"></div>
    <div id="weather" class="card"></div>

    <script>
      const API_BASE = "http://localhost:3000"; // 若後端不是 3000 port，這裡要一起改

      // ✅ 1. 頁面載入時先取得定位
      window.addEventListener("load", () => {
        const statusEl = document.getElementById("status");
        const locationEl = document.getElementById("location");

        if (!navigator.geolocation) {
          statusEl.textContent =
            "此瀏覽器不支援定位功能，改用預設城市（台北市）。";
          fetchWeatherByCity("台北市");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { latitude, longitude } = position.coords;

            statusEl.textContent = "已取得您的位置 ✅";
            locationEl.textContent = `座標：${latitude.toFixed(
              4
            )}, ${longitude.toFixed(4)}`;

            // ✅ 這裡改成真的用座標換城市（呼叫後端 /api/reverse-geocode）
            const city = await getCityFromCoords(latitude, longitude);

            if (!city) {
              statusEl.textContent += "（無法判斷城市，改用台北市）";
              fetchWeatherByCity("台北市");
              return;
            }

            statusEl.textContent += `（判斷城市：${city}）`;
            fetchWeatherByCity(city);
          },
          (error) => {
            console.error("取得定位失敗：", error);
            statusEl.textContent =
              "無法取得您的位置，改用預設城市（台北市）。";
            fetchWeatherByCity("台北市");
          }
        );
      });

      // ✅ 2. 呼叫後端 /api/weather?city=xxx
      async function fetchWeatherByCity(city) {
        const weatherEl = document.getElementById("weather");
        weatherEl.innerHTML = `正在載入 ${city} 的天氣資料...`;

        try {
          const res = await fetch(
            `${API_BASE}/api/weather?city=${encodeURIComponent(city)}`
          );

          if (!res.ok) {
            const text = await res.text();
            console.error("weather API HTTP error:", res.status, text);
            weatherEl.innerHTML =
              '<div class="error">取得天氣失敗（HTTP ' +
              res.status +
              "）</div>";
            return;
          }

          const json = await res.json();

          if (!json.success) {
            console.warn("weather API 回傳失敗：", json);
            weatherEl.innerHTML =
              '<div class="error">取得天氣失敗：' +
              (json.message || "未知錯誤") +
              "</div>";
            return;
          }

          renderWeather(json.data);
        } catch (err) {
          console.error("fetchWeatherByCity 發生錯誤：", err);
          weatherEl.innerHTML =
            '<div class="error">無法連線到伺服器，請確認後端是否有啟動。</div>';
        }
      }

      // ✅ 3. 把後端回傳的資料顯示出來
      function renderWeather(data) {
        const weatherEl = document.getElementById("weather");

        if (!data || !Array.isArray(data.forecasts)) {
          weatherEl.innerHTML =
            '<div class="error">天氣資料格式錯誤，請稍後再試。</div>';
          return;
        }

        const forecasts = data.forecasts.slice(0, 3); // 先顯示前 3 筆預報就好

        let html = `
          <div class="city">${data.city}</div>
          <div class="meta">資料描述：${data.updateTime}</div>
          <ul>
        `;

        forecasts.forEach((f) => {
          html += `
            <li>
              <div><strong>${f.startTime} ~ ${f.endTime}</strong></div>
              <div>天氣：${f.weather}</div>
              <div>氣溫：${f.minTemp} - ${f.maxTemp}</div>
              <div>降雨機率：${f.rain}</div>
              <div>舒適度：${f.comfort}</div>
              <div>風速：${f.windSpeed}</div>
            </li>
            <br/>
          `;
        });

        html += "</ul>";

        weatherEl.innerHTML = html;
      }

      // ✅ 4. 用經緯度問後端 /api/reverse-geocode，得到縣市名稱
      async function getCityFromCoords(lat, lng) {
        try {
          const url = `${API_BASE}/api/reverse-geocode?lat=${lat}&lng=${lng}`;
          console.log("呼叫 reverse-geocode:", url);

          const res = await fetch(url);

          if (!res.ok) {
            const text = await res.text();
            console.error(
              "reverse-geocode HTTP 錯誤:",
              res.status,
              text
            );
            return null;
          }

          const json = await res.json();

          if (!json.success) {
            console.warn("reverse-geocode 回傳失敗：", json);
            return null;
          }

          console.log("reverse-geocode 結果 city =", json.city);
          return json.city;
        } catch (err) {
          console.error("getCityFromCoords 發生錯誤：", err);
          return null;
        }
      }
    </script>
  </body>
</html>
