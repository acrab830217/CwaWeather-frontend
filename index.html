<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>å¤©æ°£å°å·¥å…·</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        max-width: 600px;
      }
      .city {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 12px;
      }
      .error {
        color: #c00;
        font-weight: bold;
      }
      ul {
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <h1>ç›®å‰åœ°é»å¤©æ°£</h1>
    <div id="status">æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...</div>
    <div id="location"></div>
    <div id="weather" class="card"></div>

    <script>
      // âœ… 1. é é¢è¼‰å…¥æ™‚å…ˆå–å¾—å®šä½
      window.addEventListener("load", () => {
        const statusEl = document.getElementById("status");
        const locationEl = document.getElementById("location");

        if (!navigator.geolocation) {
          statusEl.textContent =
            "æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ï¼Œæ”¹ç”¨é è¨­åŸå¸‚ï¼ˆå°åŒ—å¸‚ï¼‰ã€‚";
          // æ²’æœ‰å®šä½å°±ç”¨é è¨­åŸå¸‚
          fetchWeatherByCity("å°åŒ—å¸‚");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { latitude, longitude } = position.coords;

            statusEl.textContent = "å·²å–å¾—æ‚¨çš„ä½ç½® âœ…";
            locationEl.textContent = `åº§æ¨™ï¼š${latitude.toFixed(
              4
            )}, ${longitude.toFixed(4)}`;

            // â¬‡ï¸ é€™è£¡æœ‰å…©å€‹é¸æ“‡ â¬‡ï¸
            // å…ˆç”¨ç°¡å–®ç‰ˆï¼šç›´æ¥é¸ä¸€å€‹ä½ æƒ³æ¸¬è©¦çš„åŸå¸‚
            const city = "é«˜é›„å¸‚";
            // é€²éšç‰ˆï¼šç­‰ä½ ä¹‹å¾Œè¦çœŸçš„ç”¨åº§æ¨™æ›ç¸£å¸‚ï¼Œå†æŠŠä¸Šé¢é‚£è¡Œæ”¹æˆï¼š
            // const city = await getCityFromCoords(latitude, longitude);

            fetchWeatherByCity(city);
          },
          (error) => {
            console.error("å–å¾—å®šä½å¤±æ•—ï¼š", error);
            statusEl.textContent =
              "ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œæ”¹ç”¨é è¨­åŸå¸‚ï¼ˆå°åŒ—å¸‚ï¼‰ã€‚";
            // æŠ“ä¸åˆ°ä½ç½®å°±ç”¨é è¨­åŸå¸‚
            fetchWeatherByCity("å°åŒ—å¸‚");
          }
        );
      });

      // âœ… 2. å‘¼å«ä½ å‰›å‰›åšå¥½çš„å¾Œç«¯ /api/weather?city=xxx
      async function fetchWeatherByCity(city) {
        const weatherEl = document.getElementById("weather");
        weatherEl.innerHTML = `æ­£åœ¨è¼‰å…¥ ${city} çš„å¤©æ°£è³‡æ–™...`;

        try {
          const res = await fetch(
            `http://localhost:3000/api/weather?city=${encodeURIComponent(city)}`
          );
          const json = await res.json();

          if (!json.success) {
            weatherEl.innerHTML =
              '<div class="error">å–å¾—å¤©æ°£å¤±æ•—ï¼š' +
              (json.message || "æœªçŸ¥éŒ¯èª¤") +
              "</div>";
            return;
          }

          renderWeather(json.data);
        } catch (err) {
          console.error(err);
          weatherEl.innerHTML =
            '<div class="error">ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦æœ‰å•Ÿå‹•ã€‚</div>';
        }
      }

      // âœ… 3. æŠŠå¾Œç«¯å›å‚³çš„è³‡æ–™é¡¯ç¤ºå‡ºä¾†
      function renderWeather(data) {
        const weatherEl = document.getElementById("weather");

        const forecasts = data.forecasts.slice(0, 3); // å…ˆé¡¯ç¤ºå‰ 3 ç­†é å ±å°±å¥½

        let html = `
          <div class="city">${data.city}</div>
          <div class="meta">è³‡æ–™æè¿°ï¼š${data.updateTime}</div>
          <ul>
        `;

        forecasts.forEach((f) => {
          html += `
            <li>
              <div><strong>${f.startTime} ~ ${f.endTime}</strong></div>
              <div>å¤©æ°£ï¼š${f.weather}</div>
              <div>æ°£æº«ï¼š${f.minTemp} - ${f.maxTemp}</div>
              <div>é™é›¨æ©Ÿç‡ï¼š${f.rain}</div>
              <div>èˆ’é©åº¦ï¼š${f.comfort}</div>
              <div>é¢¨é€Ÿï¼š${f.windSpeed}</div>
            </li>
            <br/>
          `;
        });

        html += "</ul>";

        weatherEl.innerHTML = html;
      }

      // ğŸ” é€²éšç‰ˆé ç•™ï¼šç”¨åº§æ¨™æ›ç¸£å¸‚ï¼ˆç›®å‰å…ˆä¸å•Ÿç”¨ï¼‰
      async function getCityFromCoords(lat, lng) {
        // é€™è£¡é ç•™ä½ç½®çµ¦ä½ ä¹‹å¾Œä¸² Geocoding APIï¼ˆä¾‹å¦‚ Google / OpenStreetMapï¼‰
        // å…ˆå›å‚³ä¸€å€‹é è¨­å€¼ï¼Œç¢ºèªæ•´é«”æµç¨‹æ²’å•é¡Œï¼š
        return "é«˜é›„å¸‚";
      }
    </script>
  </body>
</html>