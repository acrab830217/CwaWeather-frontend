<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>天氣小工具</title>
    <!-- SEO 描述：50–160 字元之間 -->
    <meta
      name="description"
      content="自動偵測所在縣市並顯示台灣各地 36 小時天氣預報，支援記住上次選擇與手動切換縣市的簡易查詢工具。"
    />
    <!-- 響應式視窗設定 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* 確保在 320 / 768 / 1440 都不會水平捲動 */
      html,
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        overflow-x: hidden;
      }

      *,
      *::before,
      *::after {
        box-sizing: inherit;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        padding: 16px;
        background: #f5f5f5;
      }

      .page-wrapper {
        max-width: 960px;
        margin: 0 auto;
      }

      .card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 700px;
      }

      h1 {
        font-size: 1.5rem;
        margin: 0 0 12px;
        word-break: break-word;
      }

      #status,
      #location {
        font-size: 0.9rem;
        margin-bottom: 4px;
        word-break: break-word;
      }

      .city {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 8px;
        word-break: break-word;
      }

      .meta {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 12px;
        word-break: break-word;
      }

      .error {
        color: #c00;
        font-weight: bold;
      }

      ul {
        padding-left: 20px;
        margin: 0;
      }

      li {
        list-style: disc;
      }

      .controls {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
      }

      label {
        font-size: 0.9rem;
        margin-right: 4px;
        white-space: nowrap;
      }

      select {
        padding: 4px 8px;
        max-width: 100%;
      }

      /* 小螢幕優化（320px ~ 480px） */
      @media (max-width: 480px) {
        body {
          padding: 12px;
        }

        .card {
          padding: 12px;
        }

        h1 {
          font-size: 1.25rem;
        }
      }

      /* 中型螢幕（平板） */
      @media (min-width: 768px) {
        h1 {
          font-size: 1.75rem;
        }
      }

      /* 大螢幕（桌機寬 1440）不用特別寬度，讓內容保持置中即可 */
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <h1>目前地點天氣</h1>
      <div id="status">正在取得您的位置...</div>
      <div id="location"></div>

      <div class="controls">
        <label for="citySelect">縣市：</label>
        <select id="citySelect">
          <option value="">自動偵測中...</option>
        </select>
      </div>

      <div id="weather" class="card"></div>
    </div>

    <script>
      const API_BASE = "http://localhost:3000"; // 後端網址／port
      const CITY_STORAGE_KEY = "selectedCity"; // 記錄上次選擇的 key

      // 台灣各縣市基準座標（約略中心點）
      const CITY_COORDS = [
        { name: "宜蘭縣", lat: 24.7302791, lng: 121.7631149 },
        { name: "花蓮縣", lat: 23.9913421, lng: 121.6197276 },
        { name: "臺東縣", lat: 22.7553667, lng: 121.1506 },
        { name: "澎湖縣", lat: 23.569694, lng: 119.5664543 },
        { name: "金門縣", lat: 24.4480637, lng: 118.3856331 },
        { name: "連江縣", lat: 26.1491915, lng: 119.9389047 },
        { name: "臺北市", lat: 25.0478, lng: 121.5319 },
        { name: "新北市", lat: 25.06199, lng: 121.45703 },
        { name: "桃園市", lat: 24.9937, lng: 121.297 },
        { name: "臺中市", lat: 24.1469, lng: 120.6839 },
        { name: "臺南市", lat: 22.99083, lng: 120.21333 },
        { name: "高雄市", lat: 22.61626, lng: 120.31333 },
        { name: "基隆市", lat: 25.1283, lng: 121.742 },
        { name: "新竹縣", lat: 24.8267, lng: 121.0128333 },
        { name: "新竹市", lat: 24.80361, lng: 120.96861 },
        { name: "苗栗縣", lat: 24.5647667, lng: 120.8205167 },
        { name: "彰化縣", lat: 24.0755667, lng: 120.5444667 },
        { name: "南投縣", lat: 23.90235, lng: 120.6909167 },
        { name: "雲林縣", lat: 23.6990775, lng: 120.5245511 },
        { name: "嘉義縣", lat: 23.46333, lng: 120.58166 },
        { name: "嘉義市", lat: 23.47917, lng: 120.44889 },
        { name: "屏東縣", lat: 22.6828017, lng: 120.487928 },
      ];

      const DEFAULT_CITY = "臺北市";

      // 頁面載入：初始化選單／localStorage／定位
      window.addEventListener("load", () => {
        const statusEl = document.getElementById("status");
        const locationEl = document.getElementById("location");
        const citySelect = document.getElementById("citySelect");

        // 1. 填入所有縣市選項
        citySelect.innerHTML = ""; // 清空原本的「自動偵測中...」
        CITY_COORDS.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.name;
          opt.textContent = c.name;
          citySelect.appendChild(opt);
        });

        // 2. 查看 localStorage 是否有儲存的縣市
        const savedCity = localStorage.getItem(CITY_STORAGE_KEY);
        const isSavedCityValid = CITY_COORDS.some(
          (c) => c.name === savedCity
        );

        if (savedCity && isSavedCityValid) {
          // 有上次選擇的縣市 → 直接用它
          citySelect.value = savedCity;
          statusEl.textContent = `已載入上次選擇的縣市：${savedCity}`;
          fetchWeatherByCity(savedCity);

          // 額外：有支援定位的話，只顯示座標，不改變城市
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                locationEl.textContent = `座標：${latitude.toFixed(
                  4
                )}, ${longitude.toFixed(4)}`;
              },
              (error) => {
                console.warn("取得定位失敗（僅用於顯示）：", error);
              }
            );
          }
        } else {
          // 沒有儲存紀錄 → 用定位 + 最近縣市
          autoDetectCityWithGeolocation(
            statusEl,
            locationEl,
            citySelect
          );
        }

        // 3. 手動選縣市事件：更新畫面 + localStorage
        citySelect.addEventListener("change", (e) => {
          const city = e.target.value;
          if (!city) return;
          statusEl.textContent = `已選擇：${city}`;
          localStorage.setItem(CITY_STORAGE_KEY, city);
          fetchWeatherByCity(city);
        });
      });

      // 用定位自動選最近縣市，並記住選擇
      function autoDetectCityWithGeolocation(
        statusEl,
        locationEl,
        citySelect
      ) {
        if (!navigator.geolocation) {
          statusEl.textContent =
            "此瀏覽器不支援定位功能，改用預設城市（" +
            DEFAULT_CITY +
            "）。";
          citySelect.value = DEFAULT_CITY;
          localStorage.setItem(CITY_STORAGE_KEY, DEFAULT_CITY);
          fetchWeatherByCity(DEFAULT_CITY);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;

            statusEl.textContent = "已取得您的位置 ✅";
            locationEl.textContent = `座標：${latitude.toFixed(
              4
            )}, ${longitude.toFixed(4)}`;

            const nearest = getNearestCity(latitude, longitude);

            if (!nearest) {
              statusEl.textContent +=
                "（無法判斷最近縣市，改用 " + DEFAULT_CITY + "）";
              citySelect.value = DEFAULT_CITY;
              localStorage.setItem(CITY_STORAGE_KEY, DEFAULT_CITY);
              fetchWeatherByCity(DEFAULT_CITY);
              return;
            }

            statusEl.textContent += `（最近縣市：${nearest.name}）`;
            citySelect.value = nearest.name;
            localStorage.setItem(CITY_STORAGE_KEY, nearest.name);
            fetchWeatherByCity(nearest.name);
          },
          (error) => {
            console.error("取得定位失敗：", error);
            statusEl.textContent =
              "無法取得您的位置，改用預設城市（" +
              DEFAULT_CITY +
              "）。";
            citySelect.value = DEFAULT_CITY;
            localStorage.setItem(CITY_STORAGE_KEY, DEFAULT_CITY);
            fetchWeatherByCity(DEFAULT_CITY);
          }
        );
      }

      // 使用簡單「平面距離」找最近縣市
      function getNearestCity(lat, lng) {
        let nearest = null;
        let minDist = Infinity;

        CITY_COORDS.forEach((c) => {
          const dLat = lat - c.lat;
          const dLng = lng - c.lng;
          const dist = dLat * dLat + dLng * dLng; // 不開根號也可以，比較大小就好

          if (dist < minDist) {
            minDist = dist;
            nearest = c;
          }
        });

        return nearest;
      }

      // 呼叫後端 /api/weather?city=xxx
      async function fetchWeatherByCity(city) {
        const weatherEl = document.getElementById("weather");
        weatherEl.innerHTML = `正在載入 ${city} 的天氣資料...`;

        try {
          const res = await fetch(
            `${API_BASE}/api/weather?city=${encodeURIComponent(
              city
            )}`
          );

          if (!res.ok) {
            const text = await res.text();
            console.error("weather API HTTP error:", res.status, text);
            weatherEl.innerHTML =
              '<div class="error">取得天氣失敗（HTTP ' +
              res.status +
              "）</div>";
            return;
          }

          const json = await res.json();

          if (!json.success) {
            console.warn("weather API 回傳失敗：", json);
            weatherEl.innerHTML =
              '<div class="error">取得天氣失敗：' +
              (json.message || "未知錯誤") +
              "</div>";
            return;
          }

          renderWeather(json.data);
        } catch (err) {
          console.error("fetchWeatherByCity 發生錯誤：", err);
          weatherEl.innerHTML =
            '<div class="error">無法連線到伺服器，請確認後端是否有啟動。</div>';
        }
      }

      // 把後端回傳的資料顯示出來
      function renderWeather(data) {
        const weatherEl = document.getElementById("weather");

        if (!data || !Array.isArray(data.forecasts)) {
          weatherEl.innerHTML =
            '<div class="error">天氣資料格式錯誤，請稍後再試。</div>';
          return;
        }

        const forecasts = data.forecasts.slice(0, 3); // 先顯示前 3 筆預報

        let html = `
          <div class="city">${data.city}</div>
          <div class="meta">資料描述：${data.updateTime}</div>
          <ul>
        `;

        forecasts.forEach((f) => {
          html += `
            <li>
              <div><strong>${f.startTime} ~ ${f.endTime}</strong></div>
              <div>天氣：${f.weather}</div>
              <div>氣溫：${f.minTemp} - ${f.maxTemp}</div>
              <div>降雨機率：${f.rain}</div>
              <div>舒適度：${f.comfort}</div>
              <div>風速：${f.windSpeed}</div>
            </li>
            <br/>
          `;
        });

        html += "</ul>";

        weatherEl.innerHTML = html;
      }
    </script>
  </body>
</html>
