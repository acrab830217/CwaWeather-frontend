<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>å¤©æ°£å°å·¥å…·</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        max-width: 700px;
      }
      .city {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 12px;
      }
      .error {
        color: #c00;
        font-weight: bold;
      }
      ul {
        padding-left: 20px;
      }
      .controls {
        margin-bottom: 12px;
      }
      label {
        font-size: 14px;
        margin-right: 8px;
      }
      select {
        padding: 4px 8px;
      }
    </style>
  </head>
  <body>
    <h1>ç›®å‰åœ°é»å¤©æ°£</h1>
    <div id="status">æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...</div>
    <div id="location"></div>

    <div class="controls">
      <label for="citySelect">ç¸£å¸‚ï¼š</label>
      <select id="citySelect">
        <option value="">è‡ªå‹•åµæ¸¬ä¸­...</option>
      </select>
    </div>

    <div id="weather" class="card"></div>

    <script>
      const API_BASE = "http://localhost:3000"; // å¾Œç«¯ç¶²å€ï¼port
      const CITY_STORAGE_KEY = "selectedCity"; // ğŸ”‘ è¨˜éŒ„ä¸Šæ¬¡é¸æ“‡çš„ key

      // âœ… å°ç£å„ç¸£å¸‚åŸºæº–åº§æ¨™ï¼ˆç´„ç•¥ä¸­å¿ƒé»å³å¯ï¼‰
      const CITY_COORDS = [
        { name: "å®œè˜­ç¸£", lat: 24.7302791, lng: 121.7631149 },
        { name: "èŠ±è“®ç¸£", lat: 23.9913421, lng: 121.6197276 },
        { name: "è‡ºæ±ç¸£", lat: 22.7553667, lng: 121.1506 },
        { name: "æ¾æ¹–ç¸£", lat: 23.569694, lng: 119.5664543 },
        { name: "é‡‘é–€ç¸£", lat: 24.4480637, lng: 118.3856331 },
        { name: "é€£æ±Ÿç¸£", lat: 26.1491915, lng: 119.9389047 },
        { name: "è‡ºåŒ—å¸‚", lat: 25.0478, lng: 121.5319 },
        { name: "æ–°åŒ—å¸‚", lat: 25.06199, lng: 121.45703 },
        { name: "æ¡ƒåœ’å¸‚", lat: 24.9937, lng: 121.297 },
        { name: "è‡ºä¸­å¸‚", lat: 24.1469, lng: 120.6839 },
        { name: "è‡ºå—å¸‚", lat: 22.99083, lng: 120.21333 },
        { name: "é«˜é›„å¸‚", lat: 22.61626, lng: 120.31333 },
        { name: "åŸºéš†å¸‚", lat: 25.1283, lng: 121.742 },
        { name: "æ–°ç«¹ç¸£", lat: 24.8267, lng: 121.0128333 },
        { name: "æ–°ç«¹å¸‚", lat: 24.80361, lng: 120.96861 },
        { name: "è‹—æ —ç¸£", lat: 24.5647667, lng: 120.8205167 },
        { name: "å½°åŒ–ç¸£", lat: 24.0755667, lng: 120.5444667 },
        { name: "å—æŠ•ç¸£", lat: 23.90235, lng: 120.6909167 },
        { name: "é›²æ—ç¸£", lat: 23.6990775, lng: 120.5245511 },
        { name: "å˜‰ç¾©ç¸£", lat: 23.46333, lng: 120.58166 },
        { name: "å˜‰ç¾©å¸‚", lat: 23.47917, lng: 120.44889 },
        { name: "å±æ±ç¸£", lat: 22.6828017, lng: 120.487928 },
      ];

      const DEFAULT_CITY = "è‡ºåŒ—å¸‚";

      // âœ… é é¢è¼‰å…¥ï¼šå…ˆæŠŠä¸‹æ‹‰é¸å–®å¡é¸é …ï¼Œå†è™•ç†ã€Œä¸Šæ¬¡é¸æ“‡ã€èˆ‡å®šä½
      window.addEventListener("load", () => {
        const statusEl = document.getElementById("status");
        const locationEl = document.getElementById("location");
        const citySelect = document.getElementById("citySelect");

        // 1. å¡«å…¥æ‰€æœ‰ç¸£å¸‚é¸é …
        citySelect.innerHTML = ""; // æ¸…ç©ºåŸæœ¬çš„ã€Œè‡ªå‹•åµæ¸¬ä¸­...ã€
        CITY_COORDS.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.name;
          opt.textContent = c.name;
          citySelect.appendChild(opt);
        });

        // 2. æŸ¥çœ‹ localStorage æ˜¯å¦æœ‰å„²å­˜çš„ç¸£å¸‚
        const savedCity = localStorage.getItem(CITY_STORAGE_KEY);
        const isSavedCityValid = CITY_COORDS.some(
          (c) => c.name === savedCity
        );

        if (savedCity && isSavedCityValid) {
          // ğŸ¯ æœ‰ä¸Šæ¬¡é¸æ“‡çš„ç¸£å¸‚ â†’ ç›´æ¥ç”¨å®ƒï¼Œä¸ç”¨å†è‡ªå‹•åµæ¸¬
          citySelect.value = savedCity;
          statusEl.textContent = `å·²è¼‰å…¥ä¸Šæ¬¡é¸æ“‡çš„ç¸£å¸‚ï¼š${savedCity}`;
          fetchWeatherByCity(savedCity);

          // é¡å¤–ï¼šæœ‰æ”¯æ´å®šä½çš„è©±ï¼Œåªæ˜¯é¡¯ç¤ºåº§æ¨™ï¼Œä¸æ”¹è®ŠåŸå¸‚
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                locationEl.textContent = `åº§æ¨™ï¼š${latitude.toFixed(
                  4
                )}, ${longitude.toFixed(4)}`;
              },
              (error) => {
                console.warn("å–å¾—å®šä½å¤±æ•—ï¼ˆåƒ…ç”¨æ–¼é¡¯ç¤ºï¼‰ï¼š", error);
              }
            );
          }
        } else {
          // ğŸ§­ æ²’æœ‰å„²å­˜ç´€éŒ„ â†’ ç”¨å®šä½ + æœ€è¿‘ç¸£å¸‚
          autoDetectCityWithGeolocation(
            statusEl,
            locationEl,
            citySelect
          );
        }

        // 3. ç¶å®šã€Œæ‰‹å‹•é¸ç¸£å¸‚ã€äº‹ä»¶ï¼šæ›´æ–°ç•«é¢ + localStorage
        citySelect.addEventListener("change", (e) => {
          const city = e.target.value;
          if (!city) return;
          statusEl.textContent = `å·²é¸æ“‡ï¼š${city}`;
          localStorage.setItem(CITY_STORAGE_KEY, city); // ğŸ” å­˜èµ·ä¾†
          fetchWeatherByCity(city);
        });
      });

      // âœ… ç”¨å®šä½è‡ªå‹•é¸æœ€è¿‘ç¸£å¸‚ï¼Œä¸¦è¨˜ä½é¸æ“‡
      function autoDetectCityWithGeolocation(
        statusEl,
        locationEl,
        citySelect
      ) {
        if (!navigator.geolocation) {
          statusEl.textContent =
            "æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ï¼Œæ”¹ç”¨é è¨­åŸå¸‚ï¼ˆ" +
            DEFAULT_CITY +
            "ï¼‰ã€‚";
          citySelect.value = DEFAULT_CITY;
          localStorage.setItem(CITY_STORAGE_KEY, DEFAULT_CITY);
          fetchWeatherByCity(DEFAULT_CITY);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;

            statusEl.textContent = "å·²å–å¾—æ‚¨çš„ä½ç½® âœ…";
            locationEl.textContent = `åº§æ¨™ï¼š${latitude.toFixed(
              4
            )}, ${longitude.toFixed(4)}`;

            const nearest = getNearestCity(latitude, longitude);

            if (!nearest) {
              statusEl.textContent +=
                "ï¼ˆç„¡æ³•åˆ¤æ–·æœ€è¿‘ç¸£å¸‚ï¼Œæ”¹ç”¨ " + DEFAULT_CITY + "ï¼‰";
              citySelect.value = DEFAULT_CITY;
              localStorage.setItem(CITY_STORAGE_KEY, DEFAULT_CITY);
              fetchWeatherByCity(DEFAULT_CITY);
              return;
            }

            statusEl.textContent += `ï¼ˆæœ€è¿‘ç¸£å¸‚ï¼š${nearest.name}ï¼‰`;
            citySelect.value = nearest.name;
            localStorage.setItem(CITY_STORAGE_KEY, nearest.name); // ğŸ” å­˜èµ·ä¾†
            fetchWeatherByCity(nearest.name);
          },
          (error) => {
            console.error("å–å¾—å®šä½å¤±æ•—ï¼š", error);
            statusEl.textContent =
              "ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œæ”¹ç”¨é è¨­åŸå¸‚ï¼ˆ" +
              DEFAULT_CITY +
              "ï¼‰ã€‚";
            citySelect.value = DEFAULT_CITY;
            localStorage.setItem(CITY_STORAGE_KEY, DEFAULT_CITY); // ğŸ” å­˜èµ·ä¾†
            fetchWeatherByCity(DEFAULT_CITY);
          }
        );
      }

      // âœ… ä½¿ç”¨ç°¡å–®ã€Œå¹³é¢è·é›¢ã€æ‰¾æœ€è¿‘ç¸£å¸‚
      function getNearestCity(lat, lng) {
        let nearest = null;
        let minDist = Infinity;

        CITY_COORDS.forEach((c) => {
          const dLat = lat - c.lat;
          const dLng = lng - c.lng;
          const dist = dLat * dLat + dLng * dLng; // ä¸é–‹æ ¹è™Ÿä¹Ÿå¯ä»¥ï¼Œæ¯”è¼ƒå¤§å°å°±å¥½

          if (dist < minDist) {
            minDist = dist;
            nearest = c;
          }
        });

        return nearest;
      }

      // âœ… å‘¼å«å¾Œç«¯ /api/weather?city=xxx
      async function fetchWeatherByCity(city) {
        const weatherEl = document.getElementById("weather");
        weatherEl.innerHTML = `æ­£åœ¨è¼‰å…¥ ${city} çš„å¤©æ°£è³‡æ–™...`;

        try {
          const res = await fetch(
            `${API_BASE}/api/weather?city=${encodeURIComponent(
              city
            )}`
          );

          if (!res.ok) {
            const text = await res.text();
            console.error("weather API HTTP error:", res.status, text);
            weatherEl.innerHTML =
              '<div class="error">å–å¾—å¤©æ°£å¤±æ•—ï¼ˆHTTP ' +
              res.status +
              "ï¼‰</div>";
            return;
          }

          const json = await res.json();

          if (!json.success) {
            console.warn("weather API å›å‚³å¤±æ•—ï¼š", json);
            weatherEl.innerHTML =
              '<div class="error">å–å¾—å¤©æ°£å¤±æ•—ï¼š' +
              (json.message || "æœªçŸ¥éŒ¯èª¤") +
              "</div>";
            return;
          }

          renderWeather(json.data);
        } catch (err) {
          console.error("fetchWeatherByCity ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
          weatherEl.innerHTML =
            '<div class="error">ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦æœ‰å•Ÿå‹•ã€‚</div>';
        }
      }

      // âœ… æŠŠå¾Œç«¯å›å‚³çš„è³‡æ–™é¡¯ç¤ºå‡ºä¾†
      function renderWeather(data) {
        const weatherEl = document.getElementById("weather");

        if (!data || !Array.isArray(data.forecasts)) {
          weatherEl.innerHTML =
            '<div class="error">å¤©æ°£è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
          return;
        }

        const forecasts = data.forecasts.slice(0, 3); // å…ˆé¡¯ç¤ºå‰ 3 ç­†é å ±

        let html = `
          <div class="city">${data.city}</div>
          <div class="meta">è³‡æ–™æè¿°ï¼š${data.updateTime}</div>
          <ul>
        `;

        forecasts.forEach((f) => {
          html += `
            <li>
              <div><strong>${f.startTime} ~ ${f.endTime}</strong></div>
              <div>å¤©æ°£ï¼š${f.weather}</div>
              <div>æ°£æº«ï¼š${f.minTemp} - ${f.maxTemp}</div>
              <div>é™é›¨æ©Ÿç‡ï¼š${f.rain}</div>
              <div>èˆ’é©åº¦ï¼š${f.comfort}</div>
              <div>é¢¨é€Ÿï¼š${f.windSpeed}</div>
            </li>
            <br/>
          `;
        });

        html += "</ul>";

        weatherEl.innerHTML = html;
      }
    </script>
  </body>
</html>
